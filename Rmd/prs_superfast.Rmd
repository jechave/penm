---
title: "Superfast PRS"
author: "Julian Echave"
date: "5/12/2020"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r}
# Load libraries and functions
library(here)
library(bio3d)
library(tidyverse)
library(cowplot)
library(penm)
library(jefuns)

library(patchwork)
```

```{r}
# Set parameters
pdb_id = "2acy_A"
```


# Superfast matrices

# cpu time

## comparison of cpu times

```{r}
library(microbenchmark)
# set wt
pdb <- read.pdb(here("data-raw/2acy_A.pdb"))
wt <- set_enm(pdb,  "ca",  "ming_wall",  10.5,  F)


# mb <- microbenchmark(prs_slow(wt, 1), prs_slow(wt, 5), prs_slow(wt, 10),  prs_fast(wt),  times = 1)

mb <- microbenchmark(
  prs(wt, 5, "lfenm", 0.3, 2),
  prs(wt, 10, "lfenm", 0.3, 2),
  prs(wt, 20, "lfenm", 0.3, 2),
  prs.fast(wt,  0.3, 2),
  times = 1)

mb %>% 
  ggplot(aes(expr, time / 10^6)) +
  geom_col() +
  ylab("cpu time (ms)") +
  xlab("function call") +
  geom_label(aes(label = round(time / 10^6, 0))) +
  coord_flip()

  
```

## comparison of cpu times

```{r}
library(microbenchmark)
# set wt
pdb <- read.pdb(here("data-raw/2acy_A.pdb"))
wt <- set_enm(pdb,  "ca",  "ming_wall",  10.5,  F)


# mb <- microbenchmark(prs_slow(wt, 1), prs_slow(wt, 5), prs_slow(wt, 10),  prs_fast(wt),  times = 1)

mutants_5 <- get_mutants_table(wt, 5, "lfenm", 0.3, 2)
mutants_10 <- get_mutants_table(wt, 10, "lfenm", 0.3, 2)
mutants_20 <- get_mutants_table(wt, 20, "lfenm", 0.3, 2)

mb <- microbenchmark(
  calculate_dfj.prs(mutants_5),
  calculate_dfj.prs(mutants_10),
  calculate_dfj.prs(mutants_20),
  calculate_dfj.fast(wt, 0.3, 2),
  times = 1)

mb %>% 
  ggplot(aes(expr, time / 10^6)) +
  geom_col() +
  ylab("cpu time (ms)") +
  xlab("function call") +
  geom_label(aes(label = round(time / 10^6, 0))) +
  coord_flip()

  
```

# Comparison of results

```{r}
# set wt
pdb <- read.pdb(here("data-raw/2acy_A.pdb"))
wt <- set_enm(pdb, "ca", "ming_wall", 10.5, F)

# Slow prs calculation (simulation)
mutants <- get_mutants_table(wt, nmut_per_site = 30, mut_model = "lfenm", mut_dl_sigma = 0.3, mut_sd_min = 2)
dfij_slow <- calculate_dfij.prs(mutants)

# Fast prs calculation (analytical)
dfij_fast <- calculate_dfij.fast(wt, 0.3, 2) 

dfij_mean <- dfij_slow %>% 
  filter(mutation > 0) %>% 
  select(i, j, mutation, everything()) %>% 
  arrange(i, j, mutation) %>% 
  group_by(i, j) %>% 
  mutate(dr2ij = cumsum(dr2ij) / mutation,
         df2ij = cumsum(df2ij) / mutation,
         de2ij = cumsum(de2ij) / mutation,
         dvsij = cumsum(dvsij) / mutation,
         dvmij = cumsum(dvmij) / mutation )



dfij_slow_long <- dfij_mean %>% 
  pivot_longer(cols = dr2ij:dvmij,
               names_to = "response",
               values_to = "value")

dfij_fast_long <- dfij_fast %>% 
  pivot_longer(cols = dr2ij:dvmij,
               names_to = "response",
               values_to = "value")

dfij_long <- inner_join(dfij_slow_long, dfij_fast_long, by = c("i", "j", "response"), suffix = c(".slow", ".fast")) %>% 
  mutate(response = factor(response, levels = c("dr2ij", "df2ij", "de2ij", "dvsij", "dvmij"))) 

dfij_long
```



## dr2ij by different methods (or sets of scans)

```{r}
nmut_per_site = max(dfij_long$mutation)
dfij_long %>% 
  filter(mutation == nmut_per_site)  %>% 
  ggplot(aes(value.fast, value.slow)) +
  geom_point() +
  geom_abline() +
  facet_wrap( ~ response,  ncol = 5, scales = "free") +
  theme_minimal()
  
```




## response profiles

```{r}
nmut_per_site = max(dfij_long$mutation)
dfij_long %>% 
  filter(mutation == nmut_per_site)  %>% 
  group_by(response, i) %>% 
  summarise(value.slow = mean(value.slow), value.fast = mean(value.fast)) %>% 
  pivot_longer(cols = value.slow:value.fast,
               names_to = "algorithm",
               names_prefix = "value.",
               values_to = "value") %>% 
  ggplot(aes(i, value, color = algorithm)) +
  geom_line() +
  facet_wrap( ~ response,  scales = "free") +
  theme_minimal() +
  ggtitle("response profiles")
  
```


## response profiles, comparison

```{r}
nmut_per_site = max(dfij_long$mutation)
dfij_long %>% 
  filter(mutation == nmut_per_site)  %>% 
  group_by(response, i) %>% 
  summarise(value.slow = mean(value.slow), value.fast = mean(value.fast)) %>% 
  ggplot(aes(value.fast, value.slow)) +
  geom_point() +
  geom_abline() +
  facet_wrap( ~ response,   scales = "free") +
  theme_minimal() +
  ggtitle("response profiles")
  
```





## Influence profiles

```{r}
nmut_per_site = max(dfij_long$mutation)
dfij_long %>% 
  filter(mutation == nmut_per_site)  %>% 
  group_by(response, j) %>% 
  summarise(value.slow = mean(value.slow), value.fast = mean(value.fast)) %>% 
  pivot_longer(cols = value.slow:value.fast,
               names_to = "algorithm",
               names_prefix = "value.",
               values_to = "value") %>% 
  ggplot(aes(j, value, color = algorithm)) +
  geom_line() +
  facet_wrap( ~ response,  scales = "free") +
  theme_minimal() +
  ggtitle("influence profiles")
  
```

## Influence profiles, comparison

```{r}
nmut_per_site = max(dfij_long$mutation)
dfij_long %>% 
  filter(mutation == nmut_per_site)  %>% 
  group_by(response, j) %>% 
  summarise(value.slow = mean(value.slow), value.fast = mean(value.fast)) %>% 
  ggplot(aes(value.fast, value.slow)) +
  geom_point() +
  geom_abline() +
  facet_wrap( ~ response,  scales = "free") +
  theme_minimal() +
  ggtitle("influence profiles")
  
```



## Convergence 


```{r}

## Errors


df_matrix <- dfij_long %>% 
  group_by(mutation, response) %>% 
  summarise(error_type = "Rij", error = sd(value.slow - value.fast) / mean(value.fast))

df_response <- dfij_long %>% 
  group_by(mutation, response, i) %>% 
  summarise(value.slow = mean(value.slow), value.fast = mean(value.fast)) %>% 
  group_by(mutation, response) %>% 
  summarise(error_type = "response", error = sd(value.slow - value.fast) / mean(value.fast))

df_influence <- dfij_long %>% 
  group_by(mutation, response, j) %>% 
  summarise(value.slow = mean(value.slow), value.fast = mean(value.fast)) %>% 
  group_by(mutation, response) %>% 
  summarise(error_type = "influence", error = sd(value.slow - value.fast) / mean(value.fast))

df <- df_matrix %>% 
  rbind(df_response) %>% 
  rbind(df_influence)

```


```{r}
df %>% 
  ggplot(aes(mutation, error, color = error_type)) +
  geom_line() +
  facet_wrap(~ response, scales = "free") +
  ylab("relative error") +
  xlab("number of mutant scans") +
  scale_y_log10() +
  theme_minimal()
```


