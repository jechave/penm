---
title: "Test penm modeule of penm package"
author: "Julian Echave"
date: "4/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries and functions

```{r}
# load libraries
library(here)
library(tidyverse)
library(ggridges)
library(cowplot)
library(patchwork)
library(bio3d)
library(penm)
library(jefuns)
```


## Check pdb file and read wt coordinates

```{r}
pdb_file <- here("data-raw/2acy_A.pdb")
pdb <- read.pdb(pdb_file)

wt <- set_enm(pdb, node = "ca", model = "ming_wall", d_max = 10.5, frustrated = FALSE) 

str(wt)
```




```{r}

mut_lfenm <- get_mutant_site(wt, site_mut = 80, mutation = 1,  mut_model = "lfenm", mut_dl_sigma = 0.3, mut_sd_min = 2)
mut_sclfenm <- get_mutant_site(wt, site_mut = 80, mutation = 1, mut_model = "sclfenm",  mut_dl_sigma = 0.3, mut_sd_min = 2)

df <- tibble(protein = c("wt", "mut_lfenm", "mut_sclfenm"),
             v_min = c(
               enm_v_min(wt), 
               enm_v_min(mut_lfenm), 
               enm_v_min(mut_sclfenm)),
             g_entropy = c(
               enm_g_entropy(wt, beta_boltzmann()),
               enm_g_entropy(mut_lfenm, beta_boltzmann()),
               enm_g_entropy(mut_sclfenm, beta_boltzmann()))
             )
df
             

```

## Compare graphs

```{r}
tibble( 
  site = get_site(wt),
  cn_wt = cn_graph(get_graph(wt)),
  cn_lfenm = cn_graph(get_graph(mut_lfenm)),
  cn_sclfenm = cn_graph(get_graph(mut_sclfenm))) %>% 
  mutate(
    dcn_lfenm = cn_lfenm - cn_wt,
    dcn_sclfenm = cn_sclfenm - cn_wt
  ) %>% 
  pivot_longer(
    cols = starts_with("dcn_"),
    names_to = "case",
    values_to = "dcn"
  ) %>% 
  ggplot(aes(site, dcn, color = case)) +
  geom_line()


```
```{r}
site = get_site(wt)
msf_wt <- get_msf_site(wt)
msf_lfenm <- get_msf_site(mut_lfenm)
msf_sclfenm <- get_msf_site(mut_sclfenm)

dat <- tibble(site, msf_wt, msf_lfenm, msf_sclfenm) %>% 
  mutate(
    dmsf_wt = 0,
    dmsf_lfenm = msf_lfenm - msf_wt,
    dmsf_sclfenm = msf_sclfenm - msf_wt
  )

p1 <- dat %>% 
  pivot_longer(
    cols = starts_with("msf_"),
    names_to = "case",
    values_to = "value"
  ) %>% 
  ggplot(aes(site, value, color = case)) +
  geom_line()

p2 <- dat %>% 
  pivot_longer(
    cols = starts_with("dmsf_"),
    names_to = "case",
    values_to = "value"
  ) %>% 
  ggplot(aes(site, value, color = case)) +
  geom_line()

p1 / p2

```

## site-dependent ensemble changes
```{r}
nsites <- get_nsites(wt)

mut <- mut_sclfenm

dat <- tibble(site = get_site(wt),
              dmsfi = calculate_dmsfi(wt, mut),
              dhi = calculate_dhi(wt, mut),
              rwsipi = calculate_rwsipi(wt, mut),
              dbhati = calculate_dbhati(wt, mut)
              )
dat
```

```{r}
cor(dat[, -1])

```
```{r}
dat %>% 
  pivot_longer(
    cols = c(dhi, rwsipi, dbhati, dmsfi),
    names_to = "case",
    values_to = "value"
  ) %>% 
  ggplot(aes(site, value)) +
  geom_line() +
  facet_wrap(~case, scales = "free_y", ncol = 1)

```

