---
title: "Perturbation Response Scanning using penm"
author: "Julian Echave"
date: "5/12/2020"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r}
# Load libraries and functions
library(here)
library(tidyverse)
library(cowplot)
library(jefuns)

library(patchwork)
```

```{r}
# Set parameters
pdb_id = "2acy_A"
```


# Site-dependent response matrix

```{r}
# Prepare site-site response data

## Read dfij

dfij <- here("data-raw", paste0(pdb_id, "_dfij.csv")) %>% 
  read_csv()

### Make long-version of dfij

dfij_long <- dfij  %>% 
  pivot_longer(cols = c(dr2ij, de2ij, df2ij),
               names_to = "response",
               values_to = "value") %>% 
  mutate(response = factor(response, levels = c("df2ij", "de2ij", "dr2ij")))  %>% 
  filter(mutation > 0) 

```

## Site-site average response matrices


```{r}
dfij_long %>%
  group_by(i, j, response) %>%
  summarise(value = mean(value)) %>% 
  ungroup() %>% 
  # filter(abs(j - i) >= 1) %>% 
  group_by(response) %>% 
  mutate(value = mMnorm(value)) %>% 
  ggplot(aes(j, i, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_cowplot() +
  theme(legend.position = "none") +
  coord_fixed() +
  facet_grid(. ~ response) +
  NULL 
```


## Response matrices are not symmetric


```{r}
plot_mji_vs_mij <- function(m, title = "") {
  tm = t(m)
  df <- matrix_to_tibble(m)
  dft <- matrix_to_tibble(tm)
  df$mji = dft$mij
  
  df %>% 
    ggplot(aes(mij, mji)) +
    geom_point(size = .3, alpha = .3) +
    geom_smooth() +
    geom_abline() +
    ggtitle(title) +
    coord_fixed() +
    theme_cowplot()
}


#dr2ij asymmetry
df <- dfij %>%
  group_by(i, j) %>%
  summarise(dr2ij = mean(dr2ij),
            de2ij = mean(de2ij),
            df2ij = mean(df2ij)) %>% 
  arrange(j, i)

nsites <- length(unique(dfij$i))

p1 <- plot_mji_vs_mij(offdiag(matrix(df$df2ij, nsites, nsites)), "df2ij") 
p2 <- plot_mji_vs_mij(offdiag(matrix(df$de2ij, nsites, nsites)), "de2ij") 
p3 <- plot_mji_vs_mij(offdiag(matrix(df$dr2ij, nsites, nsites)), "dr2ij") 

plot_grid(p1, p2, p3, ncol = 3)
```

## Response is similar for independent scans (1)

```{r}
dfij_long %>%
  filter(mutation %in% c(1, 2)) %>% 
  group_by(mutation, response) %>% 
  mutate(value = mMnorm(value)) %>% 
  ggplot(aes(j, i, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_cowplot() +
  theme(legend.position = "none") +
  coord_fixed() +
  facet_grid(mutation ~ response) +
  NULL 
```

## Response is similar for independent scans (2)

```{r}
dfij_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  pivot_wider(names_from = mutation,
              names_prefix = "mutation_",
              values_from = value)  %>% 
  ggplot(aes(mutation_1, mutation_2)) +
  geom_point() +
  geom_smooth() +
  geom_abline() +
  theme_cowplot() +
  facet_wrap(~ response, ncol = 3, scales = "free")
```


## sd(response) is proportional to mean(response)


```{r}
dfij_long %>% 
  group_by(i, j, response) %>% 
  mutate(value_mean = mean(value),
         value_sd = sd(value)) %>% 
  ggplot(aes(value_mean, value_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_cowplot() +
  facet_wrap(~ response, scales = "free")
```


# Site-dependent response profile 

## Average response vs. site

* As predicted by theory: $df^2 \propto 1/\sigma^2$,  $de^2 \approx \texttt{constant}$, and $dr^2 \propto \sigma^2$.

```{r}
p1 <- dfij_long %>% 
  group_by(i, msfi, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(i, value)) +
  geom_line() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_of(i) vs. site")


p2 <- dfij_long %>% 
  group_by(i, msfi, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(msfi, value)) +
  geom_point(size = .5) +
  geom_smooth() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  NULL

p3 <- dfij_long %>% 
  group_by(i, mlmsi, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(mlmsi, value)) +
  geom_point(size = .5) +
  geom_smooth() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  NULL

p1 + p2 + p3 + plot_layout(widths = c(2, 1, 1))
```

## Average response is similar for independent scans (1)

```{r}
p1 <- dfij_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  mutate(mutation = factor(mutation)) %>% 
  group_by(mutation, i, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(i, value, color = mutation)) +
  geom_line() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_of(i) vs. site") +
  theme(legend.position = 'none') 

p2 <- dfij_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  mutate(mutation = factor(mutation)) %>% 
  group_by(mutation, i, response) %>% 
  summarise(value = mean(value)) %>% 
  pivot_wider(names_from = mutation,
              names_prefix = "mutation_",
              values_from = value) %>% 
  ggplot(aes(mutation_1, mutation_2)) +
  geom_point(size = .5) +
  geom_abline() +
  geom_smooth(method = "lm") +
  theme_cowplot() +
  facet_wrap(~ response, scales = "free", ncol = 1) +
  NULL

p1 + p2 + plot_layout(widths = c(2, 1))
```



# Mode-dependent response matrix

```{r}
# Prepare site-site response data

## Read dfij

dfnj <- here("data-raw", paste0(pdb_id, "_dfnj.csv")) %>% 
  read_csv()

### Make long-version of dfij

dfnj_long <- dfnj  %>% 
  pivot_longer(cols = c(dr2nj, de2nj, df2nj),
               names_to = "response",
               values_to = "value") %>% 
  mutate(response = factor(response, levels = c("df2nj", "de2nj", "dr2nj")))  %>% 
  filter(mutation > 0) %>% 
  mutate(n = mode)

```

## Mode-site average response matrices


```{r}
dfnj_long %>%
  group_by(n, j, response) %>%
  summarise(value = mean(value)) %>% 
  ungroup() %>% 
  # filter(abs(j - i) >= 1) %>% 
  group_by(response) %>% 
  mutate(value = mMnorm(value)) %>% 
  ggplot(aes(j, n, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_cowplot() +
  theme(legend.position = "none") +
  coord_fixed() +
  facet_grid(. ~ response) +
  NULL 
```

## Response matrices are not symmetric

* This is obviously true for mode-by-site matrices...

## Response matrix is *not* similar for independent scans (1)

```{r}
dfnj_long %>%
  filter(mutation %in% c(1, 2)) %>% 
  group_by(mutation, response) %>% 
  mutate(value = mMnorm(value)) %>% 
  ggplot(aes(j, n, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_cowplot() +
  theme(legend.position = "none") +
  coord_fixed() +
  facet_grid(mutation ~ response) +
  NULL 
```

## Response matrix is *not* similar for independent scans (2)

```{r}
dfnj_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  pivot_wider(names_from = mutation,
              names_prefix = "mutation_",
              values_from = value)  %>% 
  ggplot(aes(mutation_1, mutation_2)) +
  geom_point(size = .3, alpha = .3) +
  geom_abline() +
  theme_cowplot() +
  facet_wrap(~ response, ncol = 3, scales = "free")
```


## sd(response) is proportional to mean(response)

* There seems to be a bound $\texttt{sd}_{max} = a \times \texttt{mean}$ #check #todo


```{r}
dfnj_long %>% 
  group_by(n, j, response) %>% 
  mutate(value_mean = mean(value),
         value_sd = sd(value)) %>% 
  ggplot(aes(value_mean, value_sd)) +
  geom_point() +
  geom_abline() +
  theme_cowplot() +
  facet_wrap(~ response, scales = "free")
```


# Mode-dependent response profile

## Average response vs. mode

* As predicted by theory: $df^2 \propto 1/\sigma^2$,  $de^2 \approx \texttt{constant}$, and $dr^2 \propto \sigma^2$.
* As predicted by theory: $df^2 \propto \texttt{evalue}$,  $de^2 \approx \texttt{constant}$, and $dr^2 \propto 1/\texttt{evalue}$.

```{r}
p1 <- dfnj_long %>% 
  group_by(n, msfn, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(n, value)) +
  geom_line() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_of(n) vs. site")

p2 <- dfnj_long %>% 
  group_by(n, msfn, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(msfn, value)) +
  geom_point(size = .5) +
  geom_smooth() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_of(n) vs. msf(n)")

p3 <- dfnj_long %>% 
  mutate(evalue = 1 / msfn)  %>% 
  group_by(n, evalue, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(evalue, value)) +
  geom_point() +
  geom_smooth() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_of(n) vs. evalue(n)")

p1 + p2 + p3 + plot_layout(widths = c(2, 1, 1))
```

## Average response is similar for independent scans (1)

```{r}
p1 <- dfnj_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  mutate(mutation = factor(mutation)) %>% 
  group_by(mutation, n, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(n, value, color = mutation)) +
  geom_line() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_of(n) vs. site") +
  theme(legend.position = "none")

p2 <- dfnj_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  mutate(mutation = factor(mutation)) %>% 
  group_by(mutation, n, response) %>% 
  summarise(value = mean(value)) %>% 
  pivot_wider(names_from = mutation,
              names_prefix = "mutation_",
              values_from = value) %>% 
  ggplot(aes(mutation_1, mutation_2)) +
  geom_point() +
  geom_abline() +
  theme_cowplot() +
  facet_wrap(~ response, scales = "free", ncol = 1) 

p1 + p2 + plot_layout(width = c(2, 1))
```




# Influence profiles 

## Average response vs. mutated site j

```{r}
p1 <- dfij_long %>% 
  group_by(j, msfj, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(j, value)) +
  geom_line() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_to(j) vs. j")


p2 <- dfij_long %>% 
  group_by(j, msfj, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(msfj, value)) +
  geom_point(size = .5) +
  geom_smooth() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_of(j) vs. msf(j)")

p3 <- dfij_long %>% 
  group_by(j, mlmsj, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(mlmsj, value)) +
  geom_point(size = .5) +
  geom_smooth() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_of(j) vs. mlms(j)")

p1 + p2 + p3 + plot_layout(widths = c(2, 1, 1))
```

## Influence is similar for independent scans (1)

```{r}
p1 <- dfij_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  mutate(mutation = factor(mutation)) %>% 
  group_by(mutation, j, response) %>% 
  summarise(value = mean(value)) %>% 
  ggplot(aes(j, value, color = mutation)) +
  geom_line() +
  theme_cowplot() +
  facet_grid(response ~ ., scales = "free_y") +
  ggtitle("response_to(j) vs. site, two cans") +
  theme(legend.position = "none")

p2 <- dfij_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  mutate(mutation = factor(mutation)) %>% 
  group_by(mutation, j, response) %>% 
  summarise(value = mean(value)) %>% 
  pivot_wider(names_from = mutation,
              names_prefix = "mutation_",
              values_from = value) %>% 
  ggplot(aes(mutation_1, mutation_2)) +
  geom_point(size = .5) +
  geom_abline() +
  geom_smooth(method = "lm") +
  theme_cowplot() +
  facet_wrap(~ response, scales = "free", ncol = 1) 

p1 + p2  + plot_layout(widths = c(2, 1))
```




# Energy 

```{r}
dfej <- read_csv(here("data-raw/2acy_A_dfej.csv"))
```

```{r, eval = FALSE}
library(esquisse)
esquisser(dfej)
```

```{r}
dfej_long <- dfej %>% 
  filter(mutation > 0) %>% 
  pivot_longer(
    cols = c("dvs","dvm", "delta_g_entropy"),
    names_to = "response",
    values_to = "delta_energy"
  ) 
```

## Influence of mutating $j$ on energies

```{r}
p_site <- dfej_long %>% 
  group_by(j, msfj, mlmsj, response) %>% 
  mutate(delta_energy = mean(delta_energy)) %>% 
  ggplot(aes(j, delta_energy)) +
  geom_line() +
  facet_wrap(~ response, scales = "free_y", ncol = 1) +
  theme_minimal()


p_msfj <- dfej_long %>% 
  group_by(j, msfj, mlmsj, response) %>% 
  mutate(delta_energy = mean(delta_energy)) %>% 
  ggplot(aes(msfj, delta_energy)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ response, scales = "free_y", ncol = 1) +
  theme_minimal()

p_mlmsj <- dfej_long %>% 
  group_by(j, msfj, mlmsj, response) %>% 
  mutate(delta_energy = mean(delta_energy)) %>% 
  ggplot(aes(mlmsj, delta_energy)) +
  geom_point(size = .5) +
  geom_smooth() +
  facet_wrap(~ response, scales = "free_y", ncol = 1) +
  theme_minimal()

p_site + p_msfj + p_mlmsj + plot_layout(widths = c(2, 1, 1))
```


## Variation of energy response from scan to scan

```{r}
p1 <- dfej_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  mutate(mutation = factor(mutation)) %>% 
  ggplot(aes(j, delta_energy, color = mutation, group = mutation)) +
  geom_line() +
  scale_color_viridis_d() +
  facet_wrap(~ response, scales = "free_y", ncol = 1) +
  theme_minimal()

p2 <- dfej_long %>% 
  filter(mutation %in% c(1, 2)) %>% 
  mutate(mutation = factor(mutation)) %>% 
  select(j, mutation, response, delta_energy) %>% 
  pivot_wider(names_from = mutation,
              names_prefix = "mutation_",
              values_from = delta_energy) %>% 
  ggplot(aes(mutation_1, mutation_2)) +
  geom_point(size = .5) +
  geom_abline() +
  theme_cowplot() +
  facet_wrap(~ response, scales = "free", ncol = 1) 

p1 + p2
```

## $||de^2||/2 = \delta V_{stress} - \delta V_{min}$


```{r}
de2 <- dfij %>% 
  group_by(j, mutation) %>% 
  summarise(de2 = sum(de2ij) / 2)

p1 <- inner_join(dfej, de2) %>% 
  ggplot(aes(dvs - dvm, de2)) +
  geom_point() +
  geom_abline() +
  theme_minimal()
  
p2 <- inner_join(dfej, de2) %>% 
  group_by(j) %>% 
  summarise(dvs = mean(dvs),
            dvm = mean(dvm),
            de2 = mean(de2)) %>% 
  ggplot(aes(dvs - dvm, de2)) +
  geom_point() +
  geom_abline() +
  theme_minimal() +
  ggtitle("Averaged over mutations")

p1 + p2
  
  
  
```

# Globality

How many sites are influenced by a mutation at $j$? How many mutations affect site $i$?

## Globality of influence and response, site analysis

```{r}
# response
p1 = dfij_long %>% 
  group_by(i, mutation, msfi, mlmsi, response) %>% 
  summarise(kn = Kn(value)) %>% 
  group_by(i, msfi, mlmsi, response) %>% 
  summarise(kn = mean(kn)) %>% 
  ggplot(aes(i, kn)) +
  geom_line() +
  facet_wrap(~response, scales = "free_y", ncol = 1) +
  theme_minimal()

# influence
p2 = dfij_long %>% 
  group_by(j, mutation, msfj, mlmsj, response) %>% 
  summarise(kn = Kn(value)) %>% 
  group_by(j, msfj, mlmsj, response) %>% 
  summarise(kn = mean(kn)) %>% 
  ggplot(aes(j, kn)) +
  geom_line() +
  facet_wrap(~response, scales = "free_y", ncol = 1) +
  theme_minimal()


# influence vs response

dfi = dfij_long %>% 
  group_by(i, mutation, msfi, mlmsi, response) %>% 
  summarise(kn = Kn(value)) %>%  
  group_by(i, msfi, mlmsi, response) %>% 
  summarise(kn = mean(kn)) %>% 
  ungroup() %>% 
  transmute(site = i, msf = msfi, mlms = mlmsi, response = response, kn_resp = kn)

dfj = dfij_long %>% 
  group_by(j, mutation,  response) %>% 
  summarise(kn = Kn(value)) %>%  
  group_by(j,  response) %>% 
  summarise(kn = mean(kn)) %>% 
  ungroup() %>% 
  transmute(site = j, response = response, kn_influence = kn)

df <- inner_join(dfi, dfj) 

p3 <- df %>% 
  ggplot(aes(kn_influence, kn_resp)) +
  geom_point(size = .5) +
  geom_smooth() +
  theme_minimal() +
  facet_wrap(~response, scales = "free", ncol = 1) +
  NULL

patch1 <- p1 / p2
(patch1 | p3) + plot_layout(widths = c(2, 1))

```

## Globality of response, mode analysis

* $K_n(n)$ is the number of sites that perturb mode $n$.


```{r}
# influence vs response

dfn <-  dfnj_long %>% 
  group_by(n, mutation, msfn, response) %>% 
  summarise(kn = Kn(value)) %>%  
  group_by(n, msfn,  response) %>% 
  summarise(kn = mean(kn)) 

# response
p1_site <- dfn %>% 
  ggplot(aes(n, kn)) +
  geom_line() +
  facet_wrap(~response, scales = "free_y", ncol = 1) +
  theme_minimal()

p1_msf <- dfn %>% 
  ggplot(aes(msfn, kn)) +
  geom_point(size = .5) +
  geom_smooth() +
  facet_wrap(~response, scales = "free_y", ncol = 1) +
  theme_minimal()

p1_evalue <- dfn %>% 
  mutate(evalue = 1 / msfn) %>% 
  ggplot(aes(evalue, kn)) +
  geom_point(size = .5) +
  geom_smooth() +
  facet_wrap(~response, scales = "free_y", ncol = 1) +
  theme_minimal()

p1_site + p1_msf + p1_evalue



```


## Globality of influence, mode analysis
- $K_n(j)$ is the number of modes perturbed by $j$

```{r}
# influence
dfj <-  dfnj_long %>% 
  group_by(j, msfj, mlmsj, mutation,  response) %>% 
  summarise(kn = Kn(value)) %>%  
  group_by(j,  msfj, mlmsj, response) %>% 
  summarise(kn = mean(kn)) 
p2_site <- dfj %>% 
  ggplot(aes(j, kn)) +
  geom_line() +
  facet_wrap(~response, scales = "free_y", ncol = 1) +
  theme_minimal()

p2_msf <- dfj %>% 
  ggplot(aes(msfj, kn)) +
  geom_point(size = .5) +
  geom_smooth() +
  facet_wrap(~response, scales = "free_y", ncol = 1) +
  theme_minimal()

p2_mlms <- dfj %>% 
  ggplot(aes(mlmsj, kn)) +
  geom_point(size = .5) +
  geom_smooth() +
  facet_wrap(~response, scales = "free_y", ncol = 1) +
  theme_minimal()



p2_site + p2_msf + p2_mlms
```

