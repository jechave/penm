---
title: "Frustrated Elastic Network Models"
author: "Julian Echave"
date: "January 18, 2017"
output: html_document
---

```{r setup, include=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE)
```

# Study the effect of frustration on ENMs
```{r, echo=F}
# load libraries
library(tidyverse) #dplyr, ggplot2, purrr, etc.
library(bio3d)
library(corpcor) # package where pseudoinverse(m,tol) is
library(matrixStats)
```

```{r, echo=F}
# load functions
source("scripts/ganm_v2/readCA.R") 
source("scripts/ganm_v2/ganm-functions.R") 
source("scripts/ganm_v2/reduce_matrix.R")
source("scripts/enm-frustrated-functions.R")
```

```{r,echo=TRUE}

# set up parameters
sd.dij = 1.
TOLERANCE <- 1.e-3
deltaijMax = .1
R0 = 10
model = "hnm0"
prot = 1 # protein of input dataset to calculate
```


```{r,echo=F}
# input
# input file names
dataset.fname <- "data/monomers_dataset.csv"
pdbdir <- "data/repaired_pdbs"
dataset <- read.csv(file=dataset.fname)
```


```{r,echo=F}
# read structure 
pdbid <- as.character(dataset$pdb[prot])
chain <- as.character(dataset$chain[prot])
print(paste("protein:",pdbid,"chain:",chain))
pdb.fname <- paste("RepairPDB",pdbid,chain,sep="_")
pdb.fname <- paste(pdb.fname,".pdb",sep="")
pdb.fname <- file.path(pdbdir,pdb.fname) # structure
# read structure and select CA's
pdb <- readCA(pdb.fname)
xyz.calpha = pdb$xyz.calpha
nsites <- pdb$nsites
site <- seq(nsites)
```

## kij vs dij
```{r,echo=F}
kijMat <- calculate_kijMat(xyz.calpha,model,R0)
dijMat <- bio3d::dm.xyz(as.vector(xyz.calpha),mask.lower=F)
dat <- data.frame("dij"=as.vector(dijMat),"kij"=as.vector(kijMat))

dat %>% 
    ggplot(aes(x=dij,y=kij)) + 
    geom_point()

```

## Set up a frustrated ENM
We set up an ENM with kij = f(dij^eq) and lij != dij^eq.
```{r}
# function to minimize
f <- function(parameters,kijMat,r0,frustration=0) {
    nsites = nrow(kijMat)
    lambda = parameters[1]
    deltaijV = parameters[-1]
    deltaijMat = matrix(0,nsites,nsites)
    deltaijMat[upper.tri(deltaijMat,diag=FALSE)] <- deltaijV
    deltaijMat = deltaijMat + t(deltaijMat)
    dijMat = bio3d::dm.xyz(as.vector(r0),mask.lower=FALSE)
    lijMat = dijMat + deltaijMat
    force = calculateForce(r0,kijMat,lijMat)
    frust.energy = sum(kijMat*deltaijMat^2) 
    f = sum(force^2) + lambda*(frust.energy-frustration)
    f
}

nsites = nrow(kijMat)
p = rnorm((nsites^2-nsites)/2+1,mean=0,sd = .05)
p[1] = 1

opt <- nlm(f,p,kijMat=kijMat,r0=as.vector(xyz.calpha),frustration=0)

    
    
```

```{r,echo=F}
vijMat <- matrix(0,nsites,nsites) # this term has no effect on normal mode calculations
contacts <- cmap.xyz(as.vector(xyz.calpha),dcut=R0,scut=3,mask.lower = FALSE) # contact map
contacts[is.na(contacts)] = 0 # I need to do this because elements with abs(j-i)<=scut are NA
# start with the non-frustrated lij
kijMat <- calculate_kijMat(xyz.calpha,model,R0) #initial kijMat
lijMat <- bio3d::dm.xyz(xyz=as.vector(xyz.calpha),mask.lower = FALSE)

lijMat[kijMat == 0] <- 0 

# perturb the lij of tertiary contacts
deltaij <- matrix(rnorm(nsites*nsites,0,sd.dij),nsites,nsites)
deltaij <- .5*(deltaij + t(deltaij)) # ij and ji are the same contact
deltaij <- deltaij*contacts
deltaij <- deltaij/sqrt(mean(kijMat)) # this is to make different models comparable
lijMat.frustrated <- lijMat + deltaij

# Calculate structure of frustrated network
xyz.frustrated <- calculate_rmin(xyz.calpha,kijMat,lijMat.frustrated,maxit=10,TOL=1.e-5)

print(paste("RMSD between xyz.calpha and xyz.frustrated",
            as.character(myRMSD(xyz.calpha,xyz.frustrated))
            )
      )


```

## Compare frustrated ENM non-frustrated approximations
Now we have the "exact" potential with equilibrium conformation xyz.frustrated, and parameters kijMat and lijMat.frustrated. 
The exact hessian depends on xyz.frustrated, kijMat, and lijMat.frustrated. 

We can obtain a non-frustrated model by keeping the original kijMat and dropping the frustration terms from the hessian (which amounts to re-setting lij = dijEq.frustrated). Note that even if we keep the spring force constants of the original structure,  kmat will change because the directions eij have changed.
We will call this the "kij0" model.


Alternatively, we can obtain a non-frustrated model by recalculating kijMat for xyz.frustrated and setting lij = dijEq.frustrated.
We will call this option the "kijF" model.

We are interested in comparing the frustrated model with kij0 and kijF.


```{r,echo=F}
# Exact normal modes
hessian.exact <- calculate_hessian(xyz.frustrated,kijMat,lijMat.frustrated)
dijMat = bio3d::dm.xyz(as.vector(xyz.frustrated),mask.lower = F)
hessian.kij0 <- calculate_hessian(xyz.frustrated,kijMat,lijMat = dijMat)
kijMatF <- calculate_kijMat(xyz.frustrated,model,R0)
hessian.kijF <- calculate_hessian(xyz.frustrated,kijMatF,lijMat = dijMat)

nm = eigen(hessian.exact,symmetric=T)
nm.kij0 = eigen(hessian.kij0,symmetric = T)
nm.kijF = eigen(hessian.kijF,symmetric = T)

nmodes = 3*nsites-6 # keep non-trivial modes
mode = seq.int(from=nmodes,to=1,by=-1)

u = nm$vectors[,mode]
sigma2 = 1/nm$values[mode]
u.kij0 = nm.kij0$vectors[,mode]
sigma2.kij0 = 1/nm.kij0$values[mode]
u.kijF = nm.kijF$vectors[,mode]
sigma2.kijF = 1/nm.kijF$values[mode]
```

## Compare normal modes
We have two quadratic potentials with the same minimum conformation (xyz.frustrated) that differ in kij and lij. 
```{r}

overlap.hijF.kij0 = t(u.kij0) %*% u
overlap.hijF.kijF = t(u.kijF) %*% u
overlap.kij0.kijF = t(u.kij0) %*% u.kijF

nH.hijF.kij0 = calculate_nH(overlap.hijF.kij0)
nH.hijF.kijF = calculate_nH(overlap.hijF.kijF)
nH.kij0.kijF = calculate_nH(overlap.kij0.kijF)

dat = data.frame(mode=seq(nmodes),sigma2,sigma2.kij0,sigma2.kijF,
                 nH.hijF.kij0,nH.hijF.kijF,nH.kij0.kijF)

dat <- dat %>%
    arrange(mode) %>%
    mutate(sum.sigma2 = cumsum(sigma2),sum.sigma2.kij0=cumsum(sigma2.kij0),
              sum.sigma2.kijF=cumsum(sigma2.kijF))
```

### Sum(sigma^2)
```{r}
dat %>% 
    gather(key="variable",value="value",sum.sigma2,sum.sigma2.kij0,sum.sigma2.kijF) %>%
    ggplot(aes(x=mode,y=value,col=variable)) +
    geom_path()
```


### sigma^2
```{r}
dat %>% 
    gather(key="variable",value="value",sigma2,sigma2.kij0,sigma2.kijF) %>%
    ggplot(aes(x=mode,y=value,col=variable)) +
    geom_path()
```

### Normal-mode variability
```{r}
dat %>% 
    gather(key="variable",value="value",nH.hijF.kij0,nH.hijF.kijF,nH.kij0.kijF) %>%
    ggplot(aes(x=mode,y=value,col=variable)) +
    geom_point(size=.2)+
    geom_smooth()
```

```{r}
dat %>% 
    gather(key="variable",value="value",nH.hijF.kij0,nH.hijF.kijF,nH.kij0.kijF) %>%
    filter(mode < 100) %>%
    ggplot(aes(x=mode,y=value,col=variable)) +
    geom_point(size=.2)+
    geom_smooth()
```
