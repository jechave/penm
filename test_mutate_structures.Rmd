---
title: "Effect of mutations on ENM structure"
author: "Julian Echave"
date: "4/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries and functions

```{r}
# load libraries
library(tidyverse)
library(ggridges)
library(cowplot)
library(bio3d)
library(penm)
library(jefuns)

# source functions to use in this script
 source("mutant_scan_functions.R")
source("lfenm_plot.R")

# set paths and file names

spm_path <- "data"
pdb_path <- "data" # pdb files repaired using FoldX (by Elisha)

```



# Set up parameters

```{r}
# global parameters
beta <- beta_boltzmann()
update_enm <- FALSE # use true to recalculate entropies
frustrated <- FALSE # use true to add frustration terms to energy functions
# other parameters

param <- lst(
  enm = lst(model = "ming_wall",
            d_max = 10.5,
            frustrated = TRUE),
  mut = lst(model = "lfenm",
            dl_sigma = 0.3,
            mut_sd_min = 1,
            update_enm = NA),
  prs = lst(nmut_per_site = 2),
)

str(param)

```


# Read and preform ENM NMA of wild-type protein

## Check pdb file and read wt coordinates

```{r}
pdb_file <- "data/2acy_A.pdb"
pdb <- read.pdb(pdb_file)

# set up wild-type
wt <- prot_sc(pdb)

str(wt)

```


## Initialize wild-type

Check that it works when pdb_active_site is defined
```{r}
dummy_active_site = wt$pdb_site[5:7]
wt <- init_prot(prot = wt,
                pdb_site_active = dummy_active_site,
                ideal = wt, # look what is this ideal for (frustrated?)
                model = param$enm$model,
                d_max = param$enm$d_max,
                frustrated = T)

str(wt)
```


# Test mutational model


## Structural response, no recalculation of ENM

Note that entropy terms do not change w.r.t. wild-type.

```{r}
df <- tibble(prot = c("wt", "mut_nofrust", "mut_frust"),
             site = rep(80, 3),
             wt = lst(wt),
             mutation = c(0, 1, 1),
             update_enm = c(F, F, F),
             frustrated = c(F, F, T)) %>%
  mutate(mut_energy = pmap(list(wt, site, mutation, update_enm, frustrated), get_mut_energy)) %>%
  unnest(mut_energy) %>%
  arrange(mutation, frustrated, update_enm) %>%
  select(-prot, -wt, -mutation)

df

```



## Structural response plots

$f_{ij} = k_{ij} \delta l_{ij}$ is the force in the direction of contact $i-j$.
$de = K^{1/2} dr = C^{-1/2}df$, $dr = C df$.

Therefore, in normal-mode representation: $de_{n} = \sigma_n df_{n}$  and $dr_n = sigma_n^2 df_n$.

By analogy, in site representation, check if it's approximately so that $de^2_{i} = \sigma_n^2 df^2_{i}$  and $dr^2_i = \sigma_n^4 df^2_i$.

Remember that on average $df^2_n \propto \frac{1}{\sigma_n^2}$ and probably $df^2_i \propto 1 / \sigma_i^2$.

### Response along sites
```{r}
site = 80
mut <- get_mutant_site(wt, site, mutation = 1)
response_site_plot(wt, mut)

```

### Response along normal modes

```{r}
response_nm_plot(wt, mut)
```

```{r}
# get mutant table

mutants <- get_mutants_table(wt, nmut_per_site = param$prs$nmut_per_site)

```

### Perturbation Response Scanning: single-site mutations

```{r}


# dr2ij_mean matrix
dfij <- delta_structure_site(mutants)

pij_mean <-  dfij %>%
  group_by(i, j) %>%
  summarise(dr2ij_mean = mean(dr2ij),
            dr2ij_sd = sd(dr2ij)) %>%
  ggplot(aes(j, i, fill = sqrt(dr2ij_mean))) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_cowplot() +
  NULL +
  theme(legend.position = "none") +
  coord_fixed() +
  ggtitle("sqrt(dr2ij_mean) matrix")

pij_mean


#dr2ij asymmetry
df <- dfij %>%
  group_by(i, j) %>%
  summarise(dr2ij_mean = mean(dr2ij))

dr2ij <- df$dr2ij_mean
dim(dr2ij) <- c(length(wt$site), length(wt$site))
str(dr2ij)
dr2ji <- t(dr2ij)
df$dr2ji <- as.vector(dr2ji)

df %>%
  filter(!(i == j)) %>%
  ggplot(aes(dr2ij_mean, dr2ji)) +
  geom_point(alpha = .1) +
  theme_cowplot() +
  geom_smooth() +
  scale_x_log10() +
  scale_y_log10() +
  ggtitle("dr2ij is not symmetric")


# dr2ij over single mutation scan, vs. average over several mutation scans
df <- dfij %>%
  group_by(i, j) %>%
  summarise(dr2ij_mean = mean(dr2ij))

df <- inner_join(df, dfij)

df %>%
  filter(mutation > 0, mutation < 5) %>%
  ggplot(aes(dr2ij_mean, dr2ij, color = factor(mutation))) +
  geom_point(size = .2, alpha = .2) +
  geom_smooth(method = "lm") +
  facet_wrap(~mutation) +
  scale_x_log10() +
  scale_y_log10() +
  theme_cowplot() +
  panel_border() +
  ggtitle("dr2ij single scan similar to average over scans")

# dr2ij_sd vs. dr2ij_mean plot

pij <-  dfij %>%
  group_by(i, j) %>%
  summarise(dr2ij_mean = mean(dr2ij),
            dr2ij_sd = sd(dr2ij)) %>%
  ggplot(aes(dr2ij_mean, dr2ij_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_abline() +
  theme_cowplot() +
  theme(legend.position = "none") +
  coord_fixed() +
  NULL +
  ggtitle("sd(dr2ij) proportional to mean(dr2ij)")

pij

```

### Average response of site i

Response profile vs. site:

```{r}
# Average response of each site
dfi <- tibble(i = wt$site, msfi = get_msf_site(wt))
dat <-   inner_join(dfij, dfi)

pi_site <- dat %>%
  group_by(i, msfi) %>%
  summarise(dr2i_mean = mean(dr2ij)) %>%
  ungroup() %>%
  ggplot(aes(i, dr2i_mean)) +
  geom_line() +
  theme_cowplot() +
  NULL

pi_msf <- dat %>%
  group_by(i, msfi) %>%
  summarise(dr2i_mean = mean(dr2ij)) %>%
  ungroup() %>%
  ggplot(aes(msfi, dr2i_mean)) +
  geom_point() +
  geom_smooth() +
  theme_cowplot() +
  NULL

pi_rmsf <- dat %>%
  group_by(i, msfi) %>%
  summarise(dr2i_mean = mean(dr2ij)) %>%
  ungroup() %>%
  ggplot(aes(1 / msfi, dr2i_mean)) +
  geom_point() +
  geom_smooth() +
  theme_cowplot() +
  NULL


plot_grid(pi_site, plot_grid(pi_msf, pi_rmsf), ncol = 1)


```

### Global response to mutating j

Influence profile (dr2ij averaged over i):

```{r}
dfj <- tibble(j = wt$site, msfj = get_msf_site(wt))
dat <- inner_join(dfij, dfj)
# Average response of each site
pj_site <- dat %>%
  group_by(j, msfj) %>%
  summarise(dr2j_mean = mean(dr2ij)) %>%
  ungroup() %>%
  ggplot(aes(j, dr2j_mean)) +
  geom_line() +
  theme_cowplot() +
  NULL

pj_msf <- dat %>%
  group_by(j, msfj) %>%
  summarise(dr2j_mean = mean(dr2ij)) %>%
  ungroup() %>%
  ggplot(aes(msfj, dr2j_mean)) +
  geom_point() +
  geom_smooth() +
  theme_cowplot() +
  NULL

pj_rmsf <- dat %>%
  group_by(j, msfj) %>%
  summarise(dr2j_mean = mean(dr2ij)) %>%
  ungroup() %>%
  ggplot(aes(1 / msfj, dr2j_mean)) +
  geom_point() +
  geom_smooth() +
  theme_cowplot() +
  NULL



plot_grid(pj_site, plot_grid(pj_msf, pj_rmsf), ncol = 1)


```

## Structural response along normal modes

```{r}
dfnj <- delta_structure_mode(mutants)

df_prs_mode <- dfnj %>%
  select(j, mutation, mode, dr2nj) %>%
  rename(dr2 = dr2nj) %>%
  unnest(c(mode, dr2))

pnj = df_prs_mode %>%
  group_by(mode, j) %>%
  summarise(dr2_mean = mean(dr2),
            dr2_sd = sd(dr2)) %>%
  ggplot(aes(mode, j, fill = sqrt(dr2_mean))) +
  geom_tile() +
  scale_color_viridis_c() +
  theme_cowplot()

pn <- df_prs_mode %>%
  group_by(mode) %>%
  summarise(dr2_mean = mean(dr2),
            dr2_sd = sd(dr2)) %>%
  ggplot(aes(mode, dr2_mean)) +
  geom_line() +
  theme_cowplot()

pj <- df_prs_mode %>%
  group_by(j) %>%
  summarise(dr2_mean = mean(dr2),
            dr2_sd = sd(dr2)) %>%
  ggplot(aes(j, dr2_mean)) +
  geom_line() +
  theme_cowplot()

plot_grid(pnj, plot_grid(pn, pj), ncol = 1)
```
