---
title: "Test penm package" 
output: html_notebook
---


# Load libraries and functions

```{r}
# load libraries
library(tidyverse)
library(ggridges)
library(cowplot)
library(bio3d)
library(penm)
library(jefuns)

# source functions to use in this script
source("mutant_scan_functions.R")

# set paths and file names

spm_path <- "data"
pdb_path <- "data" # pdb files repaired using FoldX (by Elisha)

```



# Set up parameters

```{r}
# global parameters
beta <- beta_boltzmann()
nmut_per_site <- 19
update_enm <- FALSE # use true to recalculate entropies
add_frust <- FALSE # use true to add frustration terms to energy functions
# other parameters

param <- lst(
  enm = lst(model = "ming_wall",
            d_max = 10.5,
            add_frust = TRUE),
  mut = lst(model = "lfenm",
            dl_sigma = 0.3,
            sd_min = 1,
            update_enm = NA),
  prs = lst(nmut_per_site = 5),
)

str(param)

```


# Read and preform ENM NMA of wild-type protein

## Check pdb file and read wt coordinates

```{r}
# set pdb data
pdb <- "2ACY"
chain <- "A"
pdb_prefix <- "RepairPDB_"

# perform various checks of file existence and consistence
check <- pdb_file_check(pdb, chain, pdb_path, pdb_prefix)

# set up wild-type
wt <- read_pdb_sc(pdb, chain, pdb_path, pdb_prefix)

str(wt)

```


## Initialize wild-type

Check that it works when pdb_active_site is defined
```{r}
dummy_active_site = wt$pdb_site[5:7]
wt <- init_prot(prot = wt,  
                ideal = wt, # look what is this ideal for (add_frust?)
                pdb_site_active = dummy_active_site, 
                model = param$enm$model,
                d_max = param$enm$d_max,
                add_frust = T)
                
str(wt)
```

Check that it works when pdb_active_site is not defined
```{r}
wt <- read_pdb_sc(pdb, chain, pdb_path, pdb_prefix)
wt <- init_prot(wt,  sd_min = param$mut$sd_min)
str(wt)
```


## Plot and compare msf


```{r}
enm_msf_plot(wt, d_max = param$enm$d_max)
```

## Plot normal-mode matrix

```{r}
enm_modes_matrix_plot(wt)
```

## Plot a few normal modes
  
```{r}
nsites = wt$nsites
nmodes <- max(wt$enm$mode)
enm_modes_plot(wt, modes = c(1, 2, 3, 4, nmodes - 3, nmodes - 2, nmodes - 1, nmodes))
```
  


# Test mutational model


## Structural response, no recalculation of ENM

Note that entropy terms do not change w.r.t. wild-type.

```{r}
df <- tibble(prot = c("wt", "mut_nofrust", "mut_frust"),
             site = rep(80, 3),
             wt = lst(wt),
             mutation = c(0, 1, 1),
             update_enm = c(F, F, F),
             add_frust = c(F, F, T)) %>% 
  mutate(mut_energy = pmap(list(wt, site, mutation, update_enm, add_frust), get_mut_energy)) %>% 
  unnest(mut_energy) %>% 
  arrange(mutation, add_frust, update_enm) %>% 
  select(-prot, -wt, -mutation) 

df

```



## Structural response plots 

$f_{ij} = k_{ij} \delta l_{ij}$ is the force in the direction of contact $i-j$.
$de = K^{1/2} dr = C^{-1/2}df$, $dr = C df$. 

Therefore, in normal-mode representation: $de_{n} = \sigma_n df_{n}$  and $dr_n = sigma_n^2 df_n$. 

By analogy, in site representation, check if it's approximately so that $de^2_{i} = \sigma_n^2 df^2_{i}$  and $dr^2_i = \sigma_n^4 df^2_i$. 

Remember that on average $df^2_n \propto \frac{1}{\sigma_n^2}$ and probably $df^2_i \propto 1 / \sigma_i^2$.

### Response along sites
```{r}
  get_mut <-function(wt, site, mutation = 1, dl_sigma = 1) {
    get_mutant_site(wt, 
                           site, 
                           mutation, 
                    seed = 2000 + site * mutation,
                    wt, wt,
                           sd_min = param$mut$sd_min,
                           dl_sigma = dl_sigma,
                           model = param$enm$model,
                           d_max = param$enm$d_max,
                           add_frust = F,
                           update_enm = T)
  } 
site = 80
mut <- get_mutant_site(wt, site, mutation = 1)
response_site_plot(wt, mut)

```

### Response along normal modes

```{r}
response_nm_plot(wt, mut)
```


### Perturbation Response Scanning: single-site mutations

```{r}
# get mutant table
mutation <- seq(from = 0, to = 5)
j <- wt$site

prot_site <- function(prot) prot$site
prot_mode <- function(prot) prot$enm$mode
prot_evalue <- function(prot) prot$enm$evalue


df_mutants <- expand_grid(wt = list(wt), j, mutation)  %>% 
  mutate(mut = pmap(list(wt, j, mutation), get_mutant_site)) %>% 
  mutate(i = map(wt, "site"),
         dr2ij = map2(wt, mut, dr2_site),
         msfi = map(wt, msf_prot),
         mode = map(wt, prot_mode),
         evalue = map(wt, prot_evalue),
         dr2nj = map2(wt, mut, dr2_nm)) %>% 
  select(-wt, -mut)

df_j <- tibble(j = wt$site, msfj = msf_prot(wt))
df_mutants <- inner_join(df_j, df_mutants) %>% 
  select(mutation, j, i, msfj, msfi, everything())
df_mutants 
```

### Structural response along sites

Full mean response matrix:

```{r}
df_prs_site <- df_mutants %>% 
  select(j, mutation, i, msfj, msfi, dr2ij) %>% 
  unnest(c(i, msfi, dr2ij))

# dr2ij_mean matrix

pij_mean <-  df_prs_site %>% 
  group_by(i, j) %>% 
  summarise(dr2ij_mean = mean(dr2ij),
            dr2ij_sd = sd(dr2ij)) %>% 
  ggplot(aes(j, i, fill = sqrt(dr2ij_mean))) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_cowplot() +
  NULL +
  theme(legend.position = "none") +
  coord_fixed() +
  ggtitle("sqrt(dr2ij_mean) matrix")

pij_mean


#dr2ij asymmetry
df <- df_prs_site %>% 
  group_by(i, j) %>% 
  summarise(dr2ij_mean = mean(dr2ij))

dr2ij <- df$dr2ij_mean
dim(dr2ij) <- c(length(wt$site), length(wt$site))
str(dr2ij)
dr2ji <- t(dr2ij)
df$dr2ji <- as.vector(dr2ji) 

df %>% 
  filter(!(i == j)) %>% 
  ggplot(aes(dr2ij_mean, dr2ji)) +
  geom_point(alpha = .1) +
  theme_cowplot() +
  geom_smooth() +
  scale_x_log10() +
  scale_y_log10() +
  ggtitle("dr2ij is not symmetric")


# dr2ij over single mutation scan, vs. average over several mutation scans
df <- df_prs_site %>% 
  group_by(i, j) %>% 
  summarise(dr2ij_mean = mean(dr2ij))

df <- inner_join(df, df_prs_site)

df %>% 
  filter(mutation > 0, mutation < 5) %>% 
  ggplot(aes(dr2ij_mean, dr2ij, color = factor(mutation))) +
  geom_point(size = .2, alpha = .2) +
  geom_smooth(method = "lm") +
  facet_wrap(~mutation) +
  scale_x_log10() +
  scale_y_log10() +
  theme_cowplot() +
  panel_border() +
  ggtitle("dr2ij single scan similar to average over scans")

# dr2ij_sd vs. dr2ij_mean plot

pij <-  df_prs_site %>% 
  group_by(i, j) %>% 
  summarise(dr2ij_mean = mean(dr2ij),
            dr2ij_sd = sd(dr2ij)) %>% 
  ggplot(aes(dr2ij_mean, dr2ij_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_abline() +
  theme_cowplot() +
  theme(legend.position = "none") +
  coord_fixed() +
  NULL +
  ggtitle("sd(dr2ij) proportional to mean(dr2ij)")

pij






```

### Average response of site i

Response profile vs. site:

```{r}
# Average response of each site
pi_site <- df_prs_site %>% 
  group_by(i, msfi) %>% 
  summarise(dr2i_mean = mean(dr2ij)) %>% 
  ungroup() %>% 
  ggplot(aes(i, dr2i_mean)) +
  geom_line() +
  theme_cowplot() +
  NULL

pi_msf <- df_prs_site %>% 
  group_by(i, msfi) %>% 
  summarise(dr2i_mean = mean(dr2ij)) %>% 
  ungroup() %>% 
  ggplot(aes(msfi, dr2i_mean)) +
  geom_point() +
  geom_smooth() +
  theme_cowplot() +
  NULL

pi_rmsf <- df_prs_site %>% 
  group_by(i, msfi) %>% 
  summarise(dr2i_mean = mean(dr2ij)) %>% 
  ungroup() %>% 
  ggplot(aes(1 / msfi, dr2i_mean)) +
  geom_point() +
  geom_smooth() +
  theme_cowplot() +
  NULL


plot_grid(pi_site, plot_grid(pi_msf, pi_rmsf), ncol = 1)


```

### Global response to mutating j

Influence profile (dr2ij averaged over i):

```{r}
# Average response of each site
pj_site <- df_prs_site %>% 
  group_by(j, msfj) %>% 
  summarise(dr2j_mean = mean(dr2ij)) %>% 
  ungroup() %>% 
  ggplot(aes(j, dr2j_mean)) +
  geom_line() +
  theme_cowplot() +
  NULL

pj_msf <- df_prs_site %>% 
  group_by(j, msfj) %>% 
  summarise(dr2j_mean = mean(dr2ij)) %>% 
  ungroup() %>% 
  ggplot(aes(msfj, dr2j_mean)) +
  geom_point() +
  geom_smooth() +
  theme_cowplot() +
  NULL

pj_rmsf <- df_prs_site %>% 
  group_by(j, msfj) %>% 
  summarise(dr2j_mean = mean(dr2ij)) %>% 
  ungroup() %>% 
  ggplot(aes(1 / msfj, dr2j_mean)) +
  geom_point() +
  geom_smooth() +
  theme_cowplot() +
  NULL



plot_grid(pj_site, plot_grid(pj_msf, pj_rmsf), ncol = 1)


```

## Structural response along normal modes

```{r}
df_prs_mode <- df_mutants %>% 
  select(j, mutation, mode, dr2nj) %>% 
  rename(dr2 = dr2nj) %>% 
  unnest(c(mode, dr2))

pnj = df_prs_mode %>% 
  group_by(mode, j) %>% 
  summarise(dr2_mean = mean(dr2),
            dr2_sd = sd(dr2)) %>% 
  ggplot(aes(mode, j, fill = sqrt(dr2_mean))) +
  geom_tile() +
  scale_color_viridis_c() +
  theme_cowplot()

pn <- df_prs_mode %>% 
  group_by(mode) %>% 
  summarise(dr2_mean = mean(dr2),
            dr2_sd = sd(dr2)) %>% 
  ggplot(aes(mode, dr2_mean)) +
  geom_line() +
  theme_cowplot()

pj <- df_prs_mode %>% 
  group_by(j) %>% 
  summarise(dr2_mean = mean(dr2),
            dr2_sd = sd(dr2)) %>% 
  ggplot(aes(j, dr2_mean)) +
  geom_line() +
  theme_cowplot()

plot_grid(pnj, plot_grid(pn, pj), ncol = 1)
```

# Mutating structure and motions

## Effect of ENM changes on entropic contributions

Check that entropic tontributions to energy change when update_enm = TRUE

```{r}


df <- tibble(prot = c("wt", "mutff", "mutft", "muttf", "muttt"),
             site = rep(80, 5),
             wt = lst(wt),
             mutation = c(0, 1, 1, 1, 1),
             update_enm = c(F, F, F, T, T),
             add_frust = c(F, F, T, F, T)) %>% 
  mutate(mut_energy = pmap(list(wt, site, mutation, update_enm, add_frust), get_mut_energy)) %>% 
  unnest(mut_energy) %>% 
  arrange(mutation, add_frust, update_enm) %>% 
  select(-prot, -wt, -mutation) 

df

```

## Change in msf profile

```{r}


mut <- get_mut(wt, 80, mutation = 1)

msf_wt <- msf_prot(wt)
msf_mut <- msf_prot(mut)
msf_wt

df <- tibble(site = wt$site, wt_msf = msf_wt, mut_msf = msf_mut) 

p1  = df %>% 
  mutate(min_msf = map2_dbl(wt_msf, mut_msf, min),
         max_msf = map2_dbl(wt_msf, mut_msf, max)) %>% 
  mutate(min_msf = wt_msf,
         max_msf = mut_msf) %>% 
  pivot_longer(cols = c("wt_msf", "mut_msf"),
               names_to = "protein",
               values_to = "msf") %>% 
  ggplot(aes(site, msf, color = protein)) +
  geom_line() +
  geom_ribbon(aes(ymin = min_msf, ymax = max_msf), alpha = 1, color = NA, fill = "pink") +
  scale_color_viridis_d() +
  theme_cowplot() +
  NULL

p2 <- df %>% 
  ggplot(aes(site, (msf_mut - msf_wt)/msf_wt)) +
  geom_line() +
  theme_cowplot()

plot_grid(p1, p2)


```



```{r, eval = FALSE}


# set up site-mutant table
  spm_tbl <- spm_tbl %>% 
    unnest(site, pdb_site, cn, wcn, bfactor, bfactor_enm, d_active, .drop = TRUE) %>%
    mutate(mutation = replicate(n(), c(0:nmut_per_site), simplify = FALSE)) %>%
    unnest(mutation, .drop = TRUE)
  
  # get mutants
  spm_tbl <- spm_tbl %>% 
    mutate( 
      wt_energy = map(site, ~ wt_energy),
      mut_energy = map2(site, mutation, get_mut_energy,  
                        wt = wt, 
                        sd_min = param$mut$sd_min,
                        update_enm = update_enm, 
                        add_frust = add_frust)) 
  
  # prepare for output
  spm_tbl <- spm_tbl %>% 
    rename(wt = wt_energy, mut = mut_energy) %>% 
    mutate(wt = map(wt, as_tibble), 
           mut = map(mut, as_tibble)) %>% 
    unnest(wt, mut, .sep = "_") 
  
  # output
  pdb <- spm_tbl$pdb[[1]]
  chain <- spm_tbl$chain[[1]]
  out_file <- file.path(run_path,paste0("spm_",pdb, "_", chain, ".csv.gz"))
  write.csv(spm_tbl, file = gzfile(out_file),row.names = FALSE)

```

